package com.lxg.springboot.controller;

import com.lxg.springboot.model.HttpResult;
import com.lxg.springboot.model.OrderInfo;
import com.lxg.springboot.model.Token;
import com.lxg.springboot.service.HttpAPIService;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import com.alibaba.fastjson.JSON;
import java.util.HashMap;

import javax.annotation.Resource;

/**
 * Created by zhenghong
 * on 2017/4/25.
 */
@RestController
public class WxPayController {
	
    @Value("${wx.appid}")
    private String appid;
    @Value("${wx.appSecret}")
    private String appSecret;    
    @Value("${wx.appid}")
    private String appid;
    @Value("${wx.appSecret}")
    private String appSecret;      

	@Resource
    private HttpAPIService httpAPIService;

    @RequestMapping("wxpay/prepay")
    public String prepay(String openid) throws Exception {

		OrderInfo order = new OrderInfo();
		order.setAppid(Configure.getAppID());
		order.setMch_id(Configure.getMch_id());
		order.setNonce_str(RandomStringGenerator.getRandomStringByLength(32));
		order.setBody("dfdfdf");
		order.setOut_trade_no(RandomStringGenerator.getRandomStringByLength(32));
		order.setTotal_fee(10);
		order.setSpbill_create_ip("123.57.218.54");
		order.setNotify_url("https://www.see-source.com/weixinpay/PayResult");
		order.setTrade_type("JSAPI");
		order.setOpenid(openid);
		order.setSign_type("MD5");
		//生成签名
		String sign = Signature.getSign(order);
		order.setSign(sign);
		
		
		String result = HttpRequest.sendPost("https://api.mch.weixin.qq.com/pay/unifiedorder", order);
		System.out.println(result);
		L.info("---------下单返回:"+result);
		XStream xStream = new XStream();
		xStream.alias("xml", OrderReturnInfo.class); 

		OrderReturnInfo returnInfo = (OrderReturnInfo)xStream.fromXML(result);
		JSONObject json = new JSONObject();
		json.put("prepay_id", returnInfo.getPrepay_id());
		response.getWriter().append(json.toJSONString());
    	
    }
    
    @RequestMapping("wx/send")
    public HttpResult send(String openid, String templateid, String formid, String data, String page) throws Exception {

    	 // 获取token
   	 	 String urltoken = "https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&"
   	 	 		+ "appid="+appid+"&"
   	 	 		+ "secret="+appSecret;


   	 	 Token token = JSON.parseObject(httpAPIService.doGet(urltoken), Token.class);
    	
    	 String url = "https://api.weixin.qq.com/cgi-bin/message/wxopen/template/send?access_token="+
    			 token.getAccess_token();

         // 参数
         HashMap<String, Object> map = new HashMap<String, Object>();
         map.put("touser", openid);
         map.put("template_id", templateid);  	
         map.put("form_id", formid);
         map.put("data", JSON.parse(data));
         map.put("page", page);
         map.put("emphasis_keyword", "keyword1.DATA");
         
         HashMap<String, Object> maptemp = new HashMap<String, Object>();
         maptemp.put("Jsondata", JSON.toJSONString(map));
         
         // 请求头
         HashMap<String, Object> header = new HashMap<String, Object>();
         
         HttpResult res = httpAPIService.doPostJson(url, maptemp, header);
         
         return res;
    	
    }
    
}
